# Задача: Визуализация зон вращения + убрать hover эффект

## Файл
`lib/presentation/screens/editor/widgets/pdf_viewer/placed_image_overlay.dart`

## Изменение 1: Убрать hover эффект с изображения

Сейчас handles показываются при `widget.isSelected || _isHovered`. Нужно показывать handles **только при выделении**.

### Что изменить:

```dart
// БЫЛО (строки 316, 329, 343):
if (widget.isSelected || _isHovered)

// СТАЛО:
if (widget.isSelected)
```

Применить ко всем трём местам:
- Corner handles (строка ~316)
- Side handles (строка ~329)
- Rotate zones (строка ~343)

### Также можно упростить MouseRegion изображения:

```dart
// БЫЛО:
cursor: _isDragging
    ? SystemMouseCursors.grabbing
    : (_isHovered ? SystemMouseCursors.grab : SystemMouseCursors.basic),

// СТАЛО:
cursor: _isDragging ? SystemMouseCursors.grabbing : SystemMouseCursors.grab,
```

Переменную `_isHovered` и связанные `onEnter`/`onExit` можно оставить на будущее или удалить.

---

## Изменение 2: Визуализация зоны вращения с иконкой дуги

Заменить пустой `SizedBox` в `_RotateZone` на виджет с изогнутой стрелкой.

### Новый виджет _RotateZone:

```dart
class _RotateZone extends StatefulWidget {
  const _RotateZone({
    required this.quadrant,
    required this.onDragStart,
    required this.onDrag,
    required this.onDragEnd,
  });

  final String quadrant;  // Добавить для определения направления стрелки
  final VoidCallback onDragStart;
  final void Function(Offset globalPosition) onDrag;
  final VoidCallback onDragEnd;

  @override
  State<_RotateZone> createState() => _RotateZoneState();
}

class _RotateZoneState extends State<_RotateZone> {
  bool _isDragging = false;
  bool _isHovered = false;

  @override
  Widget build(BuildContext context) {
    const size = SelectionHandleConstants.rotateZoneSize;
    
    return MouseRegion(
      cursor: _isDragging ? SystemMouseCursors.grabbing : SystemMouseCursors.grab,
      onEnter: (_) => setState(() => _isHovered = true),
      onExit: (_) => setState(() => _isHovered = false),
      child: GestureDetector(
        behavior: HitTestBehavior.opaque,
        onPanStart: (details) {
          setState(() => _isDragging = true);
          widget.onDragStart();
        },
        onPanUpdate: (details) {
          widget.onDrag(details.globalPosition);
        },
        onPanEnd: (_) {
          setState(() => _isDragging = false);
          widget.onDragEnd();
        },
        child: SizedBox(
          width: size,
          height: size,
          child: CustomPaint(
            painter: _RotateIconPainter(
              quadrant: widget.quadrant,
              color: _isHovered || _isDragging
                  ? SelectionHandleConstants.handleBorderColor
                  : SelectionHandleConstants.handleBorderColor.withOpacity(0.5),
            ),
          ),
        ),
      ),
    );
  }
}
```

### CustomPainter для иконки вращения:

```dart
/// Paints a curved arrow icon for rotation zones.
class _RotateIconPainter extends CustomPainter {
  _RotateIconPainter({
    required this.quadrant,
    required this.color,
  });

  final String quadrant;
  final Color color;

  @override
  void paint(Canvas canvas, Size size) {
    final paint = Paint()
      ..color = color
      ..style = PaintingStyle.stroke
      ..strokeWidth = 2.0
      ..strokeCap = StrokeCap.round;

    final center = Offset(size.width / 2, size.height / 2);
    final radius = size.width * 0.35;

    // Определяем начальный и конечный углы дуги в зависимости от квадранта
    // Стрелка должна указывать направление вращения (против часовой стрелки)
    double startAngle;
    double sweepAngle = 2.0;  // ~115 градусов дуги
    
    switch (quadrant) {
      case 'topLeft':
        startAngle = 3.14;      // π (180°) - стрелка смотрит вниз-вправо
      case 'topRight':
        startAngle = -1.57;     // -π/2 (-90°) - стрелка смотрит вниз-влево
      case 'bottomLeft':
        startAngle = 1.57;      // π/2 (90°) - стрелка смотрит вверх-вправо
      case 'bottomRight':
        startAngle = 0;         // 0° - стрелка смотрит вверх-влево
      default:
        startAngle = 0;
    }

    // Рисуем дугу
    final rect = Rect.fromCircle(center: center, radius: radius);
    canvas.drawArc(rect, startAngle, sweepAngle, false, paint);

    // Рисуем стрелку на конце дуги
    final arrowAngle = startAngle + sweepAngle;
    final arrowTip = Offset(
      center.dx + radius * math.cos(arrowAngle),
      center.dy + radius * math.sin(arrowAngle),
    );

    // Направление стрелки (перпендикулярно радиусу + немного назад по дуге)
    final arrowDir = arrowAngle + 1.57 + 0.5;  // π/2 + небольшой угол
    const arrowSize = 5.0;

    final arrow1 = Offset(
      arrowTip.dx + arrowSize * math.cos(arrowDir + 0.5),
      arrowTip.dy + arrowSize * math.sin(arrowDir + 0.5),
    );
    final arrow2 = Offset(
      arrowTip.dx + arrowSize * math.cos(arrowDir - 0.5),
      arrowTip.dy + arrowSize * math.sin(arrowDir - 0.5),
    );

    canvas.drawLine(arrowTip, arrow1, paint);
    canvas.drawLine(arrowTip, arrow2, paint);
  }

  @override
  bool shouldRepaint(_RotateIconPainter oldDelegate) {
    return oldDelegate.quadrant != quadrant || oldDelegate.color != color;
  }
}
```

### Не забыть добавить import:

```dart
import 'dart:math' as math;  // Уже есть в файле
```

### Обновить вызов _RotateZone в _buildRotateZone:

```dart
Widget _buildRotateZone(String quadrant, Offset cornerPos, double rotation) {
  // ... существующий код вычисления позиции ...

  return Positioned(
    left: zoneCenter.dx - size / 2,
    top: zoneCenter.dy - size / 2,
    child: _RotateZone(
      quadrant: quadrant,  // Добавить параметр
      onDragStart: _handleRotateDragStart,
      onDrag: _handleRotateDrag,
      onDragEnd: _handleRotateDragEnd,
    ),
  );
}
```

---

## Визуальный результат

```
            ↺                      ← видимая иконка вращения (дуга со стрелкой)
              ╲
               ╲
    ┌─────────[■]─────────┐
    │                     │
   [■]      ИЗОБРАЖЕНИЕ  [■]      ← handles видны ТОЛЬКО при выделении
    │                     │
    └─────────[■]─────────┘
               ╲
                ╲
                 ↻
```

## Поведение

| Состояние | Что видно |
|-----------|-----------|
| Не выделено | Только изображение |
| Выделено | Изображение + рамка + все handles + иконки вращения |
| Hover на rotate zone | Иконка становится ярче (opacity 0.5 → 1.0) |
| Drag rotate zone | Курсор `grabbing`, иконка яркая |

---

## Чеклист

- [ ] Убран `_isHovered` из условий показа handles (3 места)
- [ ] `_RotateZone` принимает параметр `quadrant`
- [ ] Добавлен `_RotateIconPainter` с отрисовкой дуги и стрелки
- [ ] Иконка меняет opacity при hover
- [ ] Стрелки ориентированы правильно для каждого угла
- [ ] Обновлён вызов `_RotateZone` с передачей `quadrant`


